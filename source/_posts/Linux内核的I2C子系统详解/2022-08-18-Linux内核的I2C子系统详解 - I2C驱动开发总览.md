---
title: Linux内核的I2C子系统详解 - I2C驱动开发总览
date: 2022-08-18 17:32:09 +0800
categories: [Linux, I2C, 设备驱动开发]
tag: [Linux设备驱动开发, I2C]
mathjax: true
---

# 1. Linux内核里I2C子系统软件框架

## 1.1. 概述

下图展示了Linux I2C子系统的基本软件框架，大体可以分为用户空间、内核空间和硬件三个部分。

![Linux I2C子系统软件框架图](https://github.com/zjn-astonishe/Linux_Share/blob/master/Image/image/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E8%AF%A6%E8%A7%A3/Linux%E5%86%85%E6%A0%B8%E9%87%8CI2C%E5%AD%90%E7%B3%BB%E7%BB%9F%E8%BD%AF%E4%BB%B6%E6%A1%86%E6%9E%B6%E5%9B%BE.png?raw=true)

用户空间中的应用层是系统中应用程序的集合，它们通过调用内核空间封装好的API访问底层硬件设备。

对于驱动开发而言，只需关注框架的内核空间部分。在《Linux设备驱动开发详解》一书第15章《Linux I2C核心、总线与设备驱动》中，将Linux内核里的I2C子系统分为核心、总线驱动和设备驱动三部分。

### 1.1.1. I2C核心

I2C核心提供了I2C总线驱动和I2C设备驱动注册和注销的方法，I2C通信接口，与具体适配器无关的代码，以及探测设备、检测设备地址的上层代码。

### 1.1.2. I2C总线驱动

I2C总线驱动是对soc中I2C控制器的软件实现。提供I2C控制器与从设备间完成数据通信的能力。对应软件框架图中硬件抽象层部分(i2c_algorithm)和硬件实现控制层(i2c_adapter)。

### 1.1.3. I2C设备驱动

I2C设备驱动(客户驱动)是对I2C从设备的软件实现。对应软件框架图中的驱动层。

## 1.2. I2C驱动实现的两种思路

### 1.2.1. 将I2C控制器暴露给应用的方式

该方式采用标准的 `file_operations` 字符设备的形式，将 `i2c_adapter` 设备化。所实现的驱动可看作是一种" `i2c_driver` 成员函数 + 字符设备驱动"的虚拟驱动，需要由应用层通过 `read()` 、 `write()` 函数根据芯片手册直接对I2C控制器进行配置时序等操作，以实现对从设备的控制。这种方式是把对硬件的具体操作放在应用层去实现，适合用来快速测试一款I2C设备的功能，或者在 `i2c_driver` 工作不正常的时候排查具体是设备驱动工作问题还是主机驱动工作问题。并不能作为主流的开发方式。详细可见 `.../OpenHarmony/out/kernel/src_tmp/linux-5.10/drivers/i2c/i2c-dev.c` 。

### 1.2.2. 将I2C控制器抽象成公共驱动的方式

该方式是把所有代码都放在驱动层实现，直接向应用层提供最终结果，即应用层甚至可以不知道I2C的存在。例如电容式触摸屏驱动直接向应用层提供 `/dev/input/eventn` 的操作接口，接收上报到应用层的输入事件。而不需要直到具体是怎么上报的，甚至应用层不知道触摸屏是使用I2C总线和主机进行数据交互的。

# 2. Linux内核里I2C子系统代码总览

## 2.1. 核心层和总线驱动

```C++
/home/usr/Documents/OpenHarmony/out/kernel/src_tmp/linux-5.10/drivers/i2c/
├── algos               // i2c_algorithm相关，通信算法
├── busses              // i2c_adapter相关，已经编写好的各种向i2c核心层注册的适配器
├── muxes               // i2c切换芯片，不重点讨论
├── i2c-boardinfo.c     // i2c静态声明i2c设备的文件
├── i2c-core-acpi.c     // 以下i2c-core-*.c对应老版本的i2c-core.c，由内核开发者实现的，与硬件无关的代码。主要为其他各部分提供操作接口，在其内部通过结构体里面的函数指针调用硬件相关信息，即结构体里面函数指针的函数在设备加载的时候初始化
├── i2c-core-base.c
├── i2c-core.h
├── i2c-core-of.c
├── i2c-core-slave.c
├── i2c-core-smbus.c
├── i2c-dev.c
├── i2c-mux.c
├── i2c-slave-eeprom.c
├── i2c-slave-testunit.c
├── i2c-smbus.c         // 实现smbus协议的扩展文件
├── i2c-stub.c
├── Kconfig
└── Makefile

```

## 2.2. 设备驱动(以gt1x触摸屏为例)

```C++
/home/usr/Documents/OpenHarmony/out/kernel/src_tmp/linux-5.10/drivers/input/touchscreen/gt1x/
├── gt1x.c          // 设备驱动主要代码位置
├── gt1x_cfg.h
├── gt1x_extents.c
├── gt1x_firmware.h
├── gt1x_generic.c
├── gt1x_generic.h
├── gt1x.h
├── gt1x_tools.c
├── gt1x_update.c
├── GT5688_Config_20170713_1080_1920.cfg
└── Makefile
```

## 2.3. 设备树文件

```C++
/home/usr/Documents/OpenHarmony/out/kernel/src_tmp/linux-5.10/arch/arm64/boot/dts/rockchip/
├── ...
├── rk3568.dtsi
├── rk3568-linux.dtsi
├── rk3568-toybrick-mipi-tx0-beiqicloud.dtsi
├── rk3568-toybrick-x0-linux.dts
├── ...

```

## 2.4. 重要的库

```C++
/home/usr/Documents/OpenHarmony/out/kernel/src_tmp/linux-5.10/include/linux/
├── ...
├── device.h
├── ...
├── i2c.h
├── of.h
├── of_device.h
├── ...
```