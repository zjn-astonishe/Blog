---
title: RK3568 Linux的I2C总线驱动分析
date: 2022-08-09 17:26:37 +0800
categories: [Linux, RK3568, I2C驱动, 代码分析]
tag: [Linux设备驱动, RK3568]
mathjax: true
---

# RK3568 Linux的I2C总线驱动分析

## 前言

为了提高代码的重用性，解决驱动代码和设备信息耦合的问题，Linux提出了总线、设备、驱动模型。

总线上管理着两个链表，分别管理设备和驱动。每当要向系统注册一个驱动或设备时，总线负责对新插入的驱动或设备进行匹配，根据匹配结果将新插入的驱动或设备添加到所对应的管理链表中。每当要从系统移除一个驱动或设备时，总线负责将其从所对应的管理链表中删除。

由于并不是所有的设备都能够归属于常见的总线(USB、PCI、I2C、SPI),Linux为了保持设备驱动的统一性，提出了一条虚拟的、抽象出来的总线`platform`。

![platform总线、驱动、设备模型](https://github.com/zjn-astonishe/Linux_Share/blob/master/Image/image/Linux%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%E5%BC%80%E5%8F%91%E8%AF%A6%E8%A7%A3/platform%E6%80%BB%E7%BA%BF%E3%80%81%E9%A9%B1%E5%8A%A8%E3%80%81%E8%AE%BE%E5%A4%87%E6%A8%A1%E5%9E%8B.png?raw=true)

由《Linux设备驱动开发详解》一书第15章《Linux I2C核心、总线与设备驱动》可知，在Linux系统中，I2C驱动由3部分组成，即I2C核心，I2C总线驱动和I2C设备驱动。



## RK3568 I2C总线驱动概述

* 文件路径
  + `.../OpenHarmony/out/kernel/src_tmp/linux-5.10/drivers/i2c/busses/i2c-rk3x.c`
* 总线驱动：`rk3x_i2c_driver`：
  + probe方法：`rk3x_i2c_probe`
  + remove方法：`rk3x_i2c_remove`
* 通信方法集合：`rk3x_i2c_algorithm`
  + 通信方法：`rk3x_i2c_xfer`
  + 功能检测方法：`rk3x_i2c_func`
* 驱动注册和卸载方法
  + `module_platform_driver`

## RK3568 I2C总线驱动分析

### 总线驱动定义

```C++
static struct platform_driver rk3x_i2c_driver = {
	.probe   = rk3x_i2c_probe,                      
	.remove  = rk3x_i2c_remove,
	.driver  = {
		.name  = "rk3x-i2c",
		.of_match_table = rk3x_i2c_match,
		.pm = &rk3x_i2c_pm_ops,
	},
}; 

```

```C++
struct platform_driver {
/* WARNING: DO NOT EDIT, AUTO-GENERATED CODE - SEE TOP FOR INSTRUCTIONS */
 int (*probe)(struct platform_device *);
 int (*remove)(struct platform_device *);
 void (*shutdown)(struct platform_device *);
 int (*suspend)(struct platform_device *, pm_message_t state);
/* WARNING: DO NOT EDIT, AUTO-GENERATED CODE - SEE TOP FOR INSTRUCTIONS */
 int (*resume)(struct platform_device *);
 struct device_driver driver;
};
```

```C++
struct device_driver {

	const char		*name;
	struct bus_type		*bus;

	struct module		*owner;
	const char		*mod_name;	/* used for built-in modules */

	bool suppress_bind_attrs;	/* disables bind/unbind via sysfs */
	enum probe_type probe_type;

	const struct of_device_id	*of_match_table;
	const struct acpi_device_id	*acpi_match_table;

	int (*probe) (struct device *dev);
	void (*sync_state)(struct device *dev);
	int (*remove) (struct device *dev);
	void (*shutdown) (struct device *dev);
	int (*suspend) (struct device *dev, pm_message_t state);
	int (*resume) (struct device *dev);
	const struct attribute_group **groups;
	const struct attribute_group **dev_groups;

	const struct dev_pm_ops *pm;
	void (*coredump) (struct device *dev);

	struct driver_private *p;

}; 

```

### algorithm通信方法定义

### 设备树的分配方法

```C++
static const struct of_device_id rk3x_i2c_match[] = {
	{
		.compatible = "rockchip,rv1108-i2c",
		.data = &rv1108_soc_data
	},
	{
		.compatible = "rockchip,rv1126-i2c",
		.data = &rv1126_soc_data
	},
	{
		.compatible = "rockchip,rk3066-i2c",
		.data = &rk3066_soc_data
	},
	{
		.compatible = "rockchip,rk3188-i2c",
		.data = &rk3188_soc_data
	},
	{
		.compatible = "rockchip,rk3228-i2c",
		.data = &rk3228_soc_data
	},
	{
		.compatible = "rockchip,rk3288-i2c",
		.data = &rk3288_soc_data
	},
	{
		.compatible = "rockchip,rk3399-i2c",
		.data = &rk3399_soc_data
	},
	{},
};
```

### 注册平台驱动

### 总线驱动函数

#### 初始化函数probe()

#### 释放函数remove()

#### 通信方法函数xfer()

#### 功能检测函数func()

#### 总线驱动模块注册函数init()

#### 总线驱动模块卸载函数exit()
